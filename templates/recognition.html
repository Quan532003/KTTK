{% extends 'base.html' %}

{% block title %}Nhận dạng{% endblock %}

{% block extra_css %}
<style>
    .recognition-card {
        border-radius: 10px;
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .recognition-card:hover {
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        transform: translateY(-10px);
    }
    
    .recognition-icon {
        font-size: 5rem;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
    }
    
    .recognition-option {
        padding: 3rem 1.5rem;
        text-align: center;
    }
    
    .model-selector {
        margin: 2rem 0;
        padding: 1.5rem;
        border-radius: 10px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .result-panel {
        display: none;
        margin-top: 2rem;
    }
    
    .camera-feed, .video-player {
        width: 100%;
        max-width: 640px;
        height: 480px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .detection-result {
        margin-top: 1.5rem;
    }
    
    .confidence-bar {
        height: 10px;
        border-radius: 5px;
        background-color: #e9ecef;
        overflow: hidden;
        margin-top: 0.5rem;
    }
    
    .confidence-level {
        height: 100%;
        background-color: var(--success-color);
    }
    
    .result-item {
        padding: 1rem;
        border-radius: 5px;
        background-color: #f8f9fa;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
    }
    
    .result-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
    }
    
    .btn-lg {
        padding: 1rem 2rem;
        font-size: 1.2rem;
    }
    
    .recognition-actions {
        margin-top: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="header-container">
    <h1 class="page-title">Nhận dạng</h1>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card recognition-card">
            <div class="card-body recognition-option">
                <i class="fas fa-camera recognition-icon"></i>
                <h3 class="card-title">Nhận dạng qua Camera</h3>
                <p class="card-text">Sử dụng camera để phát hiện người trong thời gian thực</p>
                <a href="{{ url_for('recognize_camera') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-camera"></i> Bắt đầu
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card recognition-card">
            <div class="card-body recognition-option">
                <i class="fas fa-film recognition-icon"></i>
                <h3 class="card-title">Nhận dạng qua Video</h3>
                <p class="card-text">Tải lên video để phát hiện và nhận dạng người</p>
                <a href="{{ url_for('recognize_video') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-upload"></i> Tải lên Video
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Model Selector Panel -->
<div class="card model-selector mt-4">
    <div class="card-header">
        <i class="fas fa-cog"></i> Cấu hình nhận dạng
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="modelSelect" class="form-label">Chọn mô hình</label>
                    <select class="form-select" id="modelSelect">
                        {%for model in models%}
                        <option value={{model.idModel}}>{{model.modelType}}_{{model.version}}</option>
                        {%endfor%}
                    </select>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="confidenceThreshold" class="form-label">Ngưỡng phát hiện: <span id="confidenceValue">0.5</span></label>
                    <input type="range" class="form-range" min="0.1" max="0.9" step="0.05" value="0.5" id="confidenceThreshold">
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enableTracking" checked>
                        <label class="form-check-label" for="enableTracking">Theo dõi đối tượng</label>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showLabels" checked>
                        <label class="form-check-label" for="showLabels">Hiển thị nhãn</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Camera Result Panel (Giả lập) -->
<div class="card result-panel" id="cameraResultPanel">
    <div class="card-header">
        <i class="fas fa-camera"></i> Nhận dạng qua Camera
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <div class="camera-feed" id="cameraFeed">
                    <i class="fas fa-camera fa-3x text-muted"></i>
                    <p class="text-muted">Camera chưa được kích hoạt</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <h5>Kết quả nhận dạng</h5>
                <div class="detection-result">
                    <div class="result-item">
                        <i class="fas fa-user result-icon text-primary"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <div>Person</div>
                                <div>85%</div>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-level" style="width: 85%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="recognition-actions text-center">
            <button class="btn btn-danger me-2">
                <i class="fas fa-stop"></i> Dừng
            </button>
            <button class="btn btn-success">
                <i class="fas fa-camera"></i> Chụp ảnh
            </button>
        </div>
    </div>
</div>

<!-- Video Result Panel (Giả lập) -->
<div class="card result-panel" id="videoResultPanel">
    <div class="card-header">
        <i class="fas fa-film"></i> Nhận dạng qua Video
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <div class="video-player" id="videoPlayer">
                    <i class="fas fa-film fa-3x text-muted"></i>
                    <p class="text-muted">Chưa có video nào được tải lên</p>
                </div>
            </div>
            
            <div class="col-md-4">
                <h5>Kết quả nhận dạng</h5>
                <div class="detection-result">
                    <div class="result-item">
                        <i class="fas fa-user result-icon text-primary"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <div>Person</div>
                                <div>92%</div>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-level" style="width: 92%;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <i class="fas fa-user result-icon text-success"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <div>Person</div>
                                <div>88%</div>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-level" style="width: 88%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="recognition-actions text-center">
            <button class="btn btn-secondary me-2">
                <i class="fas fa-pause"></i> Tạm dừng
            </button>
            <button class="btn btn-danger me-2">
                <i class="fas fa-stop"></i> Dừng
            </button>
            <button class="btn btn-success">
                <i class="fas fa-save"></i> Lưu kết quả
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Cập nhật giá trị ngưỡng khi thay đổi
        const confidenceThreshold = document.getElementById('confidenceThreshold');
        const confidenceValue = document.getElementById('confidenceValue');
        
        confidenceThreshold.addEventListener('input', function() {
            confidenceValue.textContent = this.value;
        });
        
        // Kiểm tra nếu có flash message về camera hoặc video
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('mode')) {
            const mode = urlParams.get('mode');
            if (mode === 'camera') {
                document.getElementById('cameraResultPanel').style.display = 'block';
            } else if (mode === 'video') {
                document.getElementById('videoResultPanel').style.display = 'block';
            }
        }
        
        // Xử lý nút nhận dạng qua camera
        document.querySelector('a[href="{{ url_for("recognize_camera") }}"]').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('cameraResultPanel').style.display = 'block';
            document.getElementById('videoResultPanel').style.display = 'none';
            
            // Giả lập kích hoạt camera
            const cameraFeed = document.getElementById('cameraFeed');
            cameraFeed.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Đang kích hoạt camera...</p>
                </div>
            `;
            
            // Giả lập thời gian tải
            setTimeout(() => {
                cameraFeed.innerHTML = `
                    <img src="/static/placeholder-camera.jpg" alt="Camera Feed" style="max-width: 100%; height: auto;">
                `;
            }, 1500);
            
            // Thêm query parameter để lưu trạng thái
            history.pushState(null, '', '{{ url_for("recognition") }}?mode=camera');
        });
        
        // Xử lý nút nhận dạng qua video
        document.querySelector('a[href="{{ url_for("recognize_video") }}"]').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('videoResultPanel').style.display = 'block';
            document.getElementById('cameraResultPanel').style.display = 'none';
            
            // Mở hộp thoại tải lên
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'video/*';
            fileInput.click();
            
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const videoPlayer = document.getElementById('videoPlayer');
                    videoPlayer.innerHTML = `
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Đang xử lý video...</p>
                        </div>
                    `;
                    
                    // Giả lập thời gian tải
                    setTimeout(() => {
                        videoPlayer.innerHTML = `
                            <img src="/static/placeholder-video.jpg" alt="Video Player" style="max-width: 100%; height: auto;">
                        `;
                    }, 2000);
                    
                    // Thêm query parameter để lưu trạng thái
                    history.pushState(null, '', '{{ url_for("recognition") }}?mode=video');
                }
            });
        });
        
        // Xử lý nút dừng camera
        document.querySelector('#cameraResultPanel .btn-danger').addEventListener('click', function() {
            document.getElementById('cameraResultPanel').style.display = 'none';
            history.pushState(null, '', '{{ url_for("recognition") }}');
        });
        
        // Xử lý nút chụp ảnh
        document.querySelector('#cameraResultPanel .btn-success').addEventListener('click', function() {
            alert('Đã chụp ảnh và lưu kết quả nhận dạng!');
        });
        
        // Xử lý các nút của video player
        const videoBtns = document.querySelectorAll('#videoResultPanel .btn');
        
        // Nút tạm dừng
        videoBtns[0].addEventListener('click', function() {
            this.innerHTML = this.innerHTML.includes('fa-pause') 
                ? '<i class="fas fa-play"></i> Tiếp tục'
                : '<i class="fas fa-pause"></i> Tạm dừng';
        });
        
        // Nút dừng
        videoBtns[1].addEventListener('click', function() {
            document.getElementById('videoResultPanel').style.display = 'none';
            history.pushState(null, '', '{{ url_for("recognition") }}');
        });
        
        // Nút lưu kết quả
        videoBtns[2].addEventListener('click', function() {
            alert('Đã lưu kết quả nhận dạng!');
        });
        
        // Xử lý thay đổi mô hình
        document.getElementById('modelSelect').addEventListener('change', function() {
            // Giả lập thay đổi mô hình - Có thể thêm code xử lý thực tế ở đây
            console.log('Đã chọn mô hình:', this.value);
        });
        
        // Tạo hàm giả lập cập nhật kết quả nhận dạng
        function simulateDetectionResults() {
            // Tạo kết quả giả lập
            const objects = [
                { label: 'Person', confidence: Math.random() * 0.3 + 0.7 },
                { label: 'Person', confidence: Math.random() * 0.3 + 0.6 }
            ];
            
            // Cập nhật UI với kết quả giả lập
            const detectionResult = document.querySelector('#cameraResultPanel .detection-result');
            detectionResult.innerHTML = '';
            
            objects.forEach(obj => {
                const confidence = Math.round(obj.confidence * 100);
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                resultItem.innerHTML = `
                    <i class="fas fa-user result-icon text-primary"></i>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <div>${obj.label}</div>
                            <div>${confidence}%</div>
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-level" style="width: ${confidence}%;"></div>
                        </div>
                    </div>
                `;
                detectionResult.appendChild(resultItem);
            });
        }
        
        // Giả lập cập nhật kết quả nhận dạng theo định kỳ khi camera hoạt động
        let detectionInterval;
        const startDetectionSimulation = () => {
            // Xóa interval cũ nếu có
            if (detectionInterval) clearInterval(detectionInterval);
            
            // Tạo interval mới
            detectionInterval = setInterval(simulateDetectionResults, 2000);
        };
        
        // Bắt đầu giả lập khi click vào nút camera
        document.querySelector('a[href="{{ url_for("recognize_camera") }}"]').addEventListener('click', function() {
            setTimeout(startDetectionSimulation, 2000);
        });
    });
</script>
{% endblock %}