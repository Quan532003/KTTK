{% extends 'base.html' %} {% block title %}Thêm mô hình mới{% endblock %} {%
block extra_css %}
<style>
  .sample-image {
    width: 100px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #dee2e6;
  }

  .sample-table {
    margin-top: 20px;
  }

  .sample-table th,
  .sample-table td {
    vertical-align: middle;
  }

  .action-buttons {
    margin-top: 30px;
    display: flex;
    justify-content: space-between;
  }

  .modal-body .form-group {
    margin-bottom: 15px;
  }

  .image-preview {
    text-align: center;
    margin-bottom: 10px;
  }

  .description-field {
    min-height: 100px;
  }

  .badge-label {
    font-size: 0.85rem;
    padding: 5px 10px;
  }
</style>
{% endblock %} {% block content %}
<div class="header-container">
  <h1 class="page-title">Thêm mô hình mới</h1>
  <a href="{{ url_for('model_management') }}" class="btn btn-secondary">
    <i class="fas fa-arrow-left"></i> Quay lại
  </a>
</div>

<div class="card">
  <div class="card-header">
    <i class="fas fa-plus-circle"></i> Thông tin mô hình mới
  </div>
  <div class="card-body">
    <form
      action="{{ url_for('add_model') }}"
      method="post"
      enctype="multipart/form-data"
      id="addModelForm"
    >
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="model_name" class="form-label"
              >Tên mô hình <span class="text-danger">*</span></label
            >
            <input
              type="text"
              class="form-control"
              id="model_name"
              name="model_name"
              required
            />
          </div>

          <div class="mb-3">
            <label for="model_type" class="form-label"
              >Loại mô hình <span class="text-danger">*</span></label
            >
            <select
              class="form-select"
              id="model_type"
              name="model_type"
              required
            >
              <option value="">-- Chọn loại mô hình --</option>
              {% if model_types %} {% for type in model_types %}
              <option value="{type}">{{type}}</option>
              {% endfor %} {% endif %}
            </select>
          </div>

          <div class="mb-3">
            <label for="version" class="form-label"
              >Version <span class="text-danger">*</span></label
            >
            <input
              type="text"
              class="form-control"
              id="version"
              name="version"
              placeholder="v1.0.0"
              required
            />
          </div>
        </div>

        <div class="col-md-6">
          <div class="mb-3">
            <label for="description" class="form-label">Mô tả</label>
            <textarea
              class="form-control description-field"
              id="description"
              name="description"
              rows="6"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Bảng ảnh mẫu -->
      <h5 class="mt-4">Ảnh mẫu cho huấn luyện</h5>
      <div class="table-responsive sample-table">
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th style="width: 50px">Chọn</th>
              <th>ID mẫu</th>
              <th style="width: 350px height: 350px">Ảnh</th>
              <th>Nhãn</th>
              <th>Ngày tạo</th>
              <th>Bounding Box</th>
            </tr>
          </thead>
          <tbody>
            {% if sample_images %}
            {% for sample in sample_images %}
            <tr>
              <td class="text-center">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="sample_images[]"
                  value="{{ sample.idTemplate }}"
                />
              </td>
              <td>{{ sample.idTemplate }}</td>
              <td>
                <img
                  src="{{ sample.imageUrl | default('/static/placeholder-camera.jpg') }}"
                  class="sample-image"
                  alt="{{ sample.name }}"
                />
              </td>
              <td>
                {% for label in sample.labels %}
                  <span class="badge bg-info badge-label">
                    {{label.typeLabel}}
                  </span
                {%endfor%}
                >
              </td>
              <td>{{sample.timeUpdate}}</td>
              <td>
                {%for boundingBox in sample.boundingBoxList%}
                <span class="badge bg-warning badge-label">
                    {{boundingBox.xCenter, boundingBox.yCenter,boundingBox.width,boundingBox.height}}
                </span
              {%endfor%}</td>
            </tr>
            {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>

      <input type="hidden" name="model_file" value="dummy.pt" />
      <input type="hidden" name="config_file" value="dummy.yaml" />
      <input type="hidden" name="accuracy" value="0.85" />
      <input type="hidden" name="precision" value="0.83" />
      <input type="hidden" name="recall" value="0.87" />
      <input type="hidden" name="f1_score" value="0.85" />

      <!-- Training parameters (hidden fields) -->
      <input type="hidden" id="epochs" name="epochs" value="100" />
      <input type="hidden" id="batch_size" name="batch_size" value="16" />
      <input
        type="hidden"
        id="learning_rate"
        name="learning_rate"
        value="0.001"
      />

      <div class="action-buttons">
        <div>
          <button
            type="button"
            class="btn btn-info"
            data-bs-toggle="modal"
            data-bs-target="#trainingSetupModal"
          >
            <i class="fas fa-cog"></i> Thiết lập huấn luyện
          </button>
        </div>
        <div>
          <a
            href="{{ url_for('model_management') }}"
            class="btn btn-secondary me-2"
          >
            <i class="fas fa-times"></i> Hủy
          </a>
          <button type="button" class="btn btn-primary me-2" id="trainModelBtn">
            <i class="fas fa-cogs"></i> Huấn luyện
          </button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> Lưu mô hình
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Training Setup Modal -->
<div
  class="modal fade"
  id="trainingSetupModal"
  tabindex="-1"
  aria-labelledby="trainingSetupModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="trainingSetupModalLabel">
          Thiết lập tham số huấn luyện
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="modalEpochs" class="form-label">Số epochs</label>
          <input
            type="number"
            class="form-control"
            id="modalEpochs"
            value="100"
            min="1"
            max="1000"
          />
          <div class="form-text">
            Số lần lặp lại toàn bộ dữ liệu trong quá trình huấn luyện
          </div>
        </div>
        <div class="form-group">
          <label for="modalBatchSize" class="form-label">Batch size</label>
          <input
            type="number"
            class="form-control"
            id="modalBatchSize"
            value="16"
            min="1"
            max="128"
          />
          <div class="form-text">
            Số lượng mẫu được xử lý trong mỗi lần cập nhật
          </div>
        </div>
        <div class="form-group">
          <label for="modalLearningRate" class="form-label"
            >Learning rate</label
          >
          <input
            type="number"
            class="form-control"
            id="modalLearningRate"
            value="0.001"
            min="0.0001"
            max="0.1"
            step="0.0001"
          />
          <div class="form-text">Tốc độ học của thuật toán</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Đóng
        </button>
        <button type="button" class="btn btn-primary" id="saveTrainingParams">
          Lưu thiết lập
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Training Progress Modal -->
<div
  class="modal fade"
  id="trainingProgressModal"
  tabindex="-1"
  aria-labelledby="trainingProgressModalLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="trainingProgressModalLabel">
          Đang huấn luyện mô hình
        </h5>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <h5 id="trainingStatus">Đang chuẩn bị dữ liệu...</h5>
        <div class="progress mt-3">
          <div
            class="progress-bar progress-bar-striped progress-bar-animated"
            role="progressbar"
            id="trainingProgress"
            style="width: 0%"
          ></div>
        </div>
        <div class="mt-2">
          <span id="trainingProgressText">0%</span> -
          <span id="currentEpoch">Epoch 0/100</span>
        </div>
        <div class="mt-3">
          <strong>Loss:</strong> <span id="trainingLoss">0.0</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="cancelTraining">
          Hủy huấn luyện
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Lưu tham số huấn luyện từ modal
    document
      .getElementById("saveTrainingParams")
      .addEventListener("click", function () {
        const epochs = document.getElementById("modalEpochs").value;
        const batchSize = document.getElementById("modalBatchSize").value;
        const learningRate = document.getElementById("modalLearningRate").value;

        // Cập nhật giá trị vào form chính
        document.getElementById("epochs").value = epochs;
        document.getElementById("batch_size").value = batchSize;
        document.getElementById("learning_rate").value = learningRate;

        // Đóng modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("trainingSetupModal")
        );
        modal.hide();

        // Hiện thông báo
        alert("Đã lưu thiết lập huấn luyện thành công!");
      });

    // Xử lý nút huấn luyện
    document
      .getElementById("trainModelBtn")
      .addEventListener("click", function () {
        // Kiểm tra dữ liệu
        const modelName = document.getElementById("model_name").value;
        const modelType = document.getElementById("model_type").value;

        if (!modelName || !modelType) {
          alert("Vui lòng nhập đầy đủ thông tin mô hình!");
          return;
        }

        // Kiểm tra đã chọn ít nhất một ảnh mẫu
        const selectedImages = document.querySelectorAll(
          'input[name="sample_images[]"]:checked'
        );
        if (selectedImages.length === 0) {
          alert("Vui lòng chọn ít nhất một ảnh mẫu!");
          return;
        }

        // Hiện modal tiến trình huấn luyện
        const trainingModal = new bootstrap.Modal(
          document.getElementById("trainingProgressModal")
        );
        trainingModal.show();

        // Giả lập tiến trình huấn luyện
        let progress = 0;
        const totalEpochs = parseInt(document.getElementById("epochs").value);
        const progressBar = document.getElementById("trainingProgress");
        const progressText = document.getElementById("trainingProgressText");
        const currentEpoch = document.getElementById("currentEpoch");
        const trainingStatus = document.getElementById("trainingStatus");
        const trainingLoss = document.getElementById("trainingLoss");

        // Reset giá trị
        progressBar.style.width = "0%";
        progressText.textContent = "0%";
        currentEpoch.textContent = `Epoch 0/${totalEpochs}`;
        trainingStatus.textContent = "Đang chuẩn bị dữ liệu...";
        trainingLoss.textContent = "0.0";

        // Giả lập chuẩn bị dữ liệu
        setTimeout(() => {
          trainingStatus.textContent = "Đang huấn luyện...";

          const interval = setInterval(() => {
            if (progress >= 100) {
              clearInterval(interval);

              // Hoàn thành huấn luyện
              trainingStatus.textContent = "Huấn luyện hoàn tất!";

              // Tự động đóng modal sau 2 giây
              setTimeout(() => {
                trainingModal.hide();

                // Hiện thông báo
                alert(
                  `Huấn luyện mô hình "${modelName}" hoàn tất với độ chính xác 85%!`
                );
              }, 2000);

              return;
            }

            progress += 1;
            const currentEpochNum = Math.floor((progress / 100) * totalEpochs);
            const loss = (1.0 - (progress / 100) * 0.7).toFixed(4);

            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            currentEpoch.textContent = `Epoch ${currentEpochNum}/${totalEpochs}`;
            trainingLoss.textContent = loss;
          }, 100);
        }, 1500);

        // Xử lý nút hủy huấn luyện
        document
          .getElementById("cancelTraining")
          .addEventListener("click", function () {
            trainingModal.hide();
            alert("Đã hủy quá trình huấn luyện!");
          });
      });
  });
</script>
{% endblock %}
